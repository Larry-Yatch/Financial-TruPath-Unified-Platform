<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>TruPath Financial - Platform V2.0</title>
    <?!= baseUrlJs ?>
    <?!= include('styles') ?>
    <?!= include('ui-utilities') ?>
    <?!= include('api-batch-service') ?>
    <script>
      // Platform configuration (must be defined before ToolWrapper)
      const userId = '<?!= userId || "" ?>' || 'user-' + Date.now();
      const currentWeek = <?!= currentWeek || 1 ?>;
      const sessionId = '<?!= sessionId || "" ?>' || '';
    </script>
    
    <!-- Include ToolWrapper as separate HTML file with script tags -->
    <?!= include('ToolWrapper'); ?>
    
    <script>
      
      // Verify ToolWrapper loaded and define fallback if needed
      if (typeof ToolWrapper === 'undefined') {
        console.error('ToolWrapper not loaded, using fallback');
        window.ToolWrapper = {
          init: function(toolId) { 
            return '<div class="card"><p>Tool wrapper not available - using basic mode</p></div>'; 
          },
          saveDraft: function() { 
            console.warn('Save not available in basic mode'); 
          },
          loadDraft: function() { 
            console.warn('Load not available in basic mode'); 
          },
          checkForExistingDraft: function() { 
            console.log('Draft checking not available in basic mode');
          },
          updateProgressDisplay: function(progress) { 
            console.log('Progress update:', progress);
          },
          backToDashboard: function() {
            // Use form submission with correct Apps Script URL
            let baseUrl;
            try {
              const scriptPattern = /\/macros\/s\/(.*?)\/exec/;
              const parentUrl = window.parent ? window.parent.location.href : window.location.href;
              const match = parentUrl.match(scriptPattern);
              if (match) {
                baseUrl = 'https://script.google.com/macros/s/' + match[1] + '/exec';
              } else {
                baseUrl = 'https://script.google.com/macros/s/AKfycbw-xZaXS8yLYZk2rf-hGsgQvCAMP3ACjmxBeDWyl6WyIrVeBUTEWLmfau4RRLfuETp7/exec';
              }
            } catch(e) {
              baseUrl = 'https://script.google.com/macros/s/AKfycbw-xZaXS8yLYZk2rf-hGsgQvCAMP3ACjmxBeDWyl6WyIrVeBUTEWLmfau4RRLfuETp7/exec';
            }
            
            let navForm = document.createElement('form');
            navForm.method = 'GET';
            navForm.action = baseUrl;
            navForm.target = '_top';
            navForm.style.display = 'none';
            navForm.innerHTML = `
              <input type="hidden" name="route" value="dashboard">
            `;
            document.body.appendChild(navForm);
            navForm.submit();
          },
          showNotification: function(msg, type) {
            alert(msg);
          },
          initAutoSave: function() {
            console.log('Auto-save not available in basic mode');
          }
        };
      }
    </script>
  </head>
  <body>
    <!-- TruPath Financial Brand Header with Logo -->
    <div style="text-align: center; margin-bottom: 30px; padding-top: 20px;">
      <div class="logo-container" style="display: inline-block; position: relative;">
        <div style="text-align: center;">
          <img src="https://lh3.googleusercontent.com/d/1fXEp_y6Wj8nlMUbEERCNIbW9si_3v0Uw" alt="TruPath Financial Logo" style="height: 180px; width: auto;">
        </div>
        <div style="margin-top: 5px;">
          <p style="font-family: 'Rubik', sans-serif; font-size: 35px; color: #94a3b8; letter-spacing: 3px; text-transform: uppercase; font-weight: 500; margin: 0;">
            Platform V2.0
          </p>
          <p class="muted" style="margin-top: 10px;">Week <span id="current-week">1</span> of Course</p>
        </div>
      </div>
    </div>

    <div id="app" style="max-width: 1200px; margin: 0 auto;">

      <!-- Main Content -->
      <main>
        <!-- Tool Container - This will be filled with Tool 1 content -->
        <div id="tool-container">
          <!-- Tool 1 content will be loaded here automatically -->
        </div>

        <!-- Insights Panel -->
        <div id="insights-panel" class="insight-box" style="display: none;">
          <h3 style="font-size: 18px; margin-bottom: 12px; color: var(--accent-blue);">💡 Insights</h3>
          <div id="insights-content"></div>
        </div>
      </main>
    </div>

    <script>
      // Debug info
      console.log('Tool1 Page Loaded - userId:', userId, 'sessionId:', sessionId, 'currentWeek:', currentWeek);
      
      // Update week display and check for auto-load
      document.addEventListener('DOMContentLoaded', function() {
        const weekSpan = document.getElementById('current-week');
        if (weekSpan) {
          weekSpan.textContent = currentWeek;
        }
        
        // Check URL parameters for tool auto-load
        const urlParams = new URLSearchParams(window.location.search);
        const route = urlParams.get('route');
        const toolParam = urlParams.get('tool');
        
        console.log('DOMContentLoaded - route:', route, 'tool:', toolParam);
        
        // Auto-load Tool 1 immediately when this page loads
        // (index.html is ONLY for Tool 1, not a menu page)
        console.log('Loading Tool 1 Orientation Assessment...');
        setTimeout(() => {
          if (typeof loadOrientationTool === 'function') {
            loadOrientationTool();
          } else {
            console.error('loadOrientationTool function not found');
          }
        }, 100);
      });
      
      // Make loadTool globally accessible for onclick handlers
      window.loadTool = function(toolId) {
        console.log('Loading tool:', toolId);
        
        try {
          // Check if tool is available
          if (toolId === 'financial-clarity' && currentWeek < 2) {
            alert('This tool will be available in Week 2');
            return;
          }
          
          // Show loading state
          const container = document.getElementById('tool-container');
          if (!container) {
            console.error('Tool container not found!');
            alert('Error: Tool container not found. Please refresh the page.');
            return;
          }
          
          container.innerHTML = '<div style="text-align: center; padding: 40px;"><p class="muted">Loading...</p></div>';
          
          // Load tool content immediately (remove setTimeout for better reliability)
          if (toolId === 'orientation') {
            console.log('Loading orientation tool...');
            loadOrientationTool();
          } else if (toolId === 'financial-clarity') {
            console.log('Loading financial clarity tool...');
            loadFinancialClarityTool();
          } else {
            container.innerHTML = '<div style="text-align: center; padding: 40px;"><p class="muted">Tool not yet implemented</p></div>';
          }
        } catch (error) {
          console.error('Error loading tool:', error);
          const container = document.getElementById('tool-container');
          if (container) {
            container.innerHTML = '<div style="text-align: center; padding: 40px;"><p class="error">Error loading tool. Please refresh and try again.</p></div>';
          }
        }
      }
      
      // Function to start the actual Tool 1 form after landing page
      window.startTool1Form = function() {
        const landingDiv = document.getElementById('tool1-landing');
        const formDiv = document.getElementById('tool1-form');
        
        if (landingDiv) landingDiv.style.display = 'none';
        if (formDiv) formDiv.style.display = 'block';
        
        // Update progress tracking with safety check
        if (typeof ToolWrapper !== 'undefined' && ToolWrapper.updateProgressDisplay) {
          ToolWrapper.updateProgressDisplay({
            percentage: 0,
            currentStep: 1,
            totalSteps: 5,
            section: 'Basic Information'
          });
        }
        
        // NOW start autosave since form is visible
        if (typeof ToolWrapper !== 'undefined' && ToolWrapper.initAutoSave) {
          ToolWrapper.initAutoSave(300000); // 5 minutes (reduced frequency)
          
          // Show autosave indicator
          const autosaveStatus = document.getElementById('auto-save-status');
          if (autosaveStatus) {
            autosaveStatus.style.display = 'block';
          }
        }
      }
      
      // Navigation function for returning to dashboard after report
      window.navigateBackToDashboard = function() {
        console.log('Navigating back to dashboard using form submission...');
        
        // Use server-provided baseUrl as JavaScript variable
        const baseUrl = window.BASE_URL || 'https://script.google.com/macros/s/AKfycbw0NByXsEh7tszOE29ks25ZQlF0TPAtvuY9OCkrqVbyqyYOXkwnqKprTtmIZRpO1w06/exec';
        
        const currentUserId = typeof userId !== 'undefined' ? userId : 'TEST001';
        const currentSessionId = typeof sessionId !== 'undefined' ? sessionId : '';
        
        console.log('Dashboard navigation - using base URL:', baseUrl);
        console.log('Client:', currentUserId, 'Session:', currentSessionId);
        
        // Create hidden form for navigation
        let navForm = document.getElementById('report-dashboard-nav-form');
        if (!navForm) {
          navForm = document.createElement('form');
          navForm.id = 'report-dashboard-nav-form';
          navForm.method = 'GET';
          navForm.action = baseUrl;
          navForm.target = '_top';
          navForm.style.display = 'none';
          navForm.innerHTML = `
            <input type="hidden" name="route" value="dashboard">
            <input type="hidden" name="client" id="report-nav-client" value="${currentUserId}">
            <input type="hidden" name="session" id="report-nav-session" value="${currentSessionId}">
          `;
          document.body.appendChild(navForm);
        } else {
          // Update values if form already exists
          navForm.action = baseUrl;
          document.getElementById('report-nav-client').value = currentUserId;
          document.getElementById('report-nav-session').value = currentSessionId;
        }
        
        // Submit the form to navigate
        navForm.submit();
      }
      
      // Draft version selection functions (from TestTool pattern)
      // MOVED HERE: Must be defined BEFORE loadOrientationTool which uses it
      window.loadDraftWithVersions = async function() {
        console.log('⚡ Loading draft versions (BATCHED)...');
        const currentUserId = typeof userId !== 'undefined' ? userId : 'TEST_USER';
        console.log('Using userId:', currentUserId);
        
        try {
          // Use batched API service to get drafts
          const drafts = await ApiUtils.getToolDraft(currentUserId, 'tool1');
          console.log('✅ Retrieved drafts via batch service:', drafts);
          
          if (!drafts || drafts.length === 0) {
            alert('No saved drafts found. Start filling out the form to create drafts.');
            return;
          }
          
          // Process drafts for form editing
          const draftVersions = [];
          drafts.forEach(draft => {
            draft.isSubmitted = false;
            draft.label = 'Draft';
            draftVersions.push(draft);
          });
          
          displayVersionSelector(draftVersions);
          
        } catch (error) {
          console.error('❌ Error loading drafts (batched):', error);
          alert('Error loading drafts: ' + error);
        }
      }
      
      // New function: View last insights report (the formatted report, not raw data)
      window.viewLastSubmission = async function() {
        console.log('⚡ Loading last submission (BATCHED)...');
        const currentUserId = typeof userId !== 'undefined' ? userId : 'TEST_USER';
        console.log('Using userId:', currentUserId);
        
        try {
          // Use batched API service to get last submission
          const lastSubmission = await ApiUtils.getLastSubmission(currentUserId, 'tool1');
          console.log('✅ Last submission via batch service:', lastSubmission);
          
          if (!lastSubmission || !lastSubmission.data) {
            alert('No previous submissions found. Complete and submit the form first.');
            return;
          }
          
          // Generate insights report from the submission data and display it
          const report = generateLocalInsightsReport(lastSubmission.data);
          displayInsightsReportInModal(report, lastSubmission);
          
        } catch (error) {
          console.error('❌ Error loading last submission (batched):', error);
          alert('Error loading last submission: ' + error);
        }
      }
      
      // Function moved to ui-utilities.html for performance optimization
      
      // Function moved to ui-utilities.html for performance optimization
      
      // Function moved to ui-utilities.html for performance optimization
      
      // Show Help Modal with contextual information
      window.showHelpModal = function(pageType) {
        const modal = document.createElement('div');
        modal.id = 'help-modal';
        modal.className = 'tool-modal show';
        
        const backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop';
        backdrop.onclick = closeHelpModal;
        
        const modalContent = document.createElement('div');
        modalContent.className = 'modal-content';
        modalContent.style.maxWidth = '700px';
        
        const header = document.createElement('div');
        header.className = 'modal-header';
        
        const title = document.createElement('h2');
        title.textContent = '❓ Help & Button Guide';
        
        const closeBtn = document.createElement('button');
        closeBtn.className = 'close-btn';
        closeBtn.textContent = '×';
        closeBtn.onclick = closeHelpModal;
        
        header.appendChild(title);
        header.appendChild(closeBtn);
        
        const body = document.createElement('div');
        body.className = 'modal-body';
        body.style.padding = '20px';
        
        let helpContent = '';
        
        if (pageType === 'landing') {
          helpContent = `
            <h3 style="color: var(--gold); margin-bottom: 15px;">🏠 Landing Page Buttons</h3>
            
            <div class="card" style="margin-bottom: 15px;">
              <h4 style="color: var(--gold);">🚀 Start Assessment / Retake Assessment</h4>
              <p><strong>What it does:</strong> Begins a fresh assessment from the beginning. Any existing form data will be cleared.</p>
              <p><strong>When to use:</strong> When you want to start completely over or take the assessment for the first time.</p>
            </div>
            
            <div class="card" style="margin-bottom: 15px;">
              <h4 style="color: var(--gold);">📂 Continue Where I Left Off</h4>
              <p><strong>What it does:</strong> Loads your most recent draft and takes you to the form with your saved progress.</p>
              <p><strong>When to use:</strong> When you started the assessment but didn't finish it and want to pick up where you left off.</p>
              <p><strong>Note:</strong> Only appears if you have saved drafts.</p>
            </div>
            
            <div class="card" style="margin-bottom: 15px;">
              <h4 style="color: var(--gold);">📊 View Last Report</h4>
              <p><strong>What it does:</strong> Shows your complete insights report from your last submission, including homework section.</p>
              <p><strong>When to use:</strong> When you want to review your previous results, download your report, or edit your answers.</p>
              <p><strong>Note:</strong> Only appears if you have completed at least one assessment.</p>
            </div>
          `;
        } else if (pageType === 'form') {
          helpContent = `
            <h3 style="color: var(--gold); margin-bottom: 15px;">📝 Form Page Buttons</h3>
            
            <div style="background: rgba(173, 145, 104, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
              <h4 style="color: var(--gold); margin: 0 0 10px 0;">🧭 Navigation Section (Top)</h4>
            </div>
            
            <div class="card" style="margin-bottom: 15px;">
              <h4 style="color: var(--gold);">📊 View Last Report</h4>
              <p><strong>What it does:</strong> Opens your complete insights report in a modal window.</p>
              <p><strong>When to use:</strong> To reference your previous results while filling out the form, or to edit your previous answers.</p>
            </div>
            
            <div style="background: rgba(173, 145, 104, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
              <h4 style="color: var(--gold); margin: 0 0 10px 0;">💾 Draft Management (Bottom)</h4>
            </div>
            
            <div class="card" style="margin-bottom: 15px;">
              <h4 style="color: var(--gold);">📂 Load Draft</h4>
              <p><strong>What it does:</strong> Shows a list of your saved drafts and lets you choose which one to load.</p>
              <p><strong>When to use:</strong> When you have multiple saved versions and want to load a specific one.</p>
            </div>
            
            <div class="card" style="margin-bottom: 15px;">
              <h4 style="color: var(--gold);">💾 Save Progress</h4>
              <p><strong>What it does:</strong> Saves your current form responses as a draft without submitting.</p>
              <p><strong>When to use:</strong> To save your work so you can continue later. Forms auto-save every 2 minutes, but you can manually save anytime.</p>
            </div>
            
            <div class="card" style="margin-bottom: 15px;">
              <h4 style="color: var(--gold);">📊 Generate My Personalized Insights Report</h4>
              <p><strong>What it does:</strong> Submits your completed assessment and generates your full insights report with scores and recommendations.</p>
              <p><strong>When to use:</strong> When you've answered all required questions and are ready to see your results.</p>
            </div>
          `;
        } else if (pageType === 'modal') {
          helpContent = `
            <h3 style="color: var(--gold); margin-bottom: 15px;">📊 Insights Report Modal</h3>
            
            <div class="card" style="margin-bottom: 15px;">
              <h4 style="color: var(--gold);">✏️ Edit Answers & Generate New Report</h4>
              <p><strong>What it does:</strong> Closes the modal, loads your previous answers into the form, and lets you modify them.</p>
              <p><strong>When to use:</strong> When you want to change some of your responses and generate an updated report.</p>
            </div>
            
            <div class="card" style="margin-bottom: 15px;">
              <h4 style="color: var(--gold);">📄 Download Report</h4>
              <p><strong>What it does:</strong> Generates and downloads a PDF version of your insights report.</p>
              <p><strong>When to use:</strong> When you want to save or share your report externally.</p>
            </div>
            
            <div class="card" style="margin-bottom: 15px;">
              <h4 style="color: var(--gold);">✕ Close</h4>
              <p><strong>What it does:</strong> Closes the insights report modal and returns you to the previous page.</p>
              <p><strong>When to use:</strong> When you're done reviewing your report.</p>
            </div>
          `;
        }
        
        body.innerHTML = helpContent + `
          <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border);">
            <p style="color: var(--muted); font-size: 14px;">
              💡 <strong>Tip:</strong> All your data is automatically saved to prevent loss. You can safely navigate between sections.
            </p>
          </div>
        `;
        
        modalContent.appendChild(header);
        modalContent.appendChild(body);
        modal.appendChild(backdrop);
        modal.appendChild(modalContent);
        
        document.body.appendChild(modal);
      }
      
      // Close Help Modal
      function closeHelpModal() {
        const modal = document.getElementById('help-modal');
        if (modal) {
          modal.remove();
        }
      }
      
      // Helper function to load data into form (reuse existing logic)
      function populateFormWithData(data) {
        console.log('Loading data into form for editing:', data);
        
        // Iterate through data and populate form fields
        Object.keys(data).forEach(key => {
          const element = document.querySelector(`[name="${key}"]`);
          if (element) {
            if (element.type === 'radio' || element.type === 'checkbox') {
              const valueElement = document.querySelector(`[name="${key}"][value="${data[key]}"]`);
              if (valueElement) {
                valueElement.checked = true;
              }
            } else {
              element.value = data[key];
            }
          }
        });
      }
      
      // Fix missing restoreFormData function
      function restoreFormData(data) {
        if (!data) {
          console.warn('No data provided to restoreFormData');
          return;
        }
        
        try {
          // Restore form field values
          for (const [fieldName, value] of Object.entries(data)) {
            const field = document.querySelector(`[name="${fieldName}"]`);
            if (field) {
              field.value = value;
              
              // Trigger any change events for range inputs
              if (field.type === 'range') {
                field.dispatchEvent(new Event('input'));
              }
            }
          }
          
          console.log('Form data restored successfully');
        } catch (error) {
          console.error('Error restoring form data:', error);
        }
      }
      
      function displayVersionSelector(versions) {
            
            // Create modal for version selection
            const modal = document.createElement('div');
            modal.id = 'draft-modal';
            modal.className = 'tool-modal show';
            modal.innerHTML = `
              <div class="modal-backdrop" onclick="closeDraftModal()"></div>
              <div class="modal-content">
                <div class="modal-header">
                  <h2>Select Version to Load</h2>
                  <button class="close-btn" onclick="closeDraftModal()">×</button>
                </div>
                <div class="modal-body">
                  <div class="draft-list">
                    ${versions.map((version, index) => {
                      const timestamp = version.timestamp ? new Date(version.timestamp).toLocaleString() : 'Unknown time';
                      const progress = version.progress || 0;
                      const label = version.label || 'Version';
                      const bgColor = version.isSubmitted ? 'rgba(76, 175, 80, 0.1)' : 'rgba(173, 145, 104, 0.05)';
                      const borderColor = version.isSubmitted ? 'rgba(76, 175, 80, 0.3)' : 'rgba(173, 145, 104, 0.2)';
                      const icon = version.isSubmitted ? '✅' : '📝';
                      
                      return `
                        <div class="draft-item card" onclick="selectDraftVersion(${index})" 
                             style="cursor: pointer; margin-bottom: 10px; padding: 15px; 
                                    background: ${bgColor}; border: 1px solid ${borderColor};">
                          <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                              <strong>${icon} ${label} ${!version.isSubmitted ? (index + 1) : ''}</strong>
                              <div style="font-size: 0.9em; color: var(--muted);">${timestamp}</div>
                            </div>
                            <div style="text-align: right;">
                              <div style="font-size: 1.2em; font-weight: bold; color: ${version.isSubmitted ? '#4CAF50' : 'var(--gold)'};">
                                ${progress}%
                              </div>
                              <div style="font-size: 0.8em; color: var(--muted);">
                                ${version.isSubmitted ? 'Submitted' : 'Draft'}
                              </div>
                            </div>
                          </div>
                        </div>
                      `;
                    }).join('')}
                  </div>
                </div>
              </div>
            `;
            
            document.body.appendChild(modal);
            
            // Store versions globally for selection
            window.availableDrafts = versions;
      }
      
      window.closeDraftModal = function() {
        const modal = document.getElementById('draft-modal');
        if (modal) {
          modal.remove();
        }
      }
      
      window.closeNoDraftsModal = function() {
        const modal = document.getElementById('no-drafts-modal');
        if (modal) {
          modal.remove();
        }
      }
      
      // Status-aware landing page (Option C)
      window.checkUserStatusAndUpdateLanding = function() {
        const currentUserId = typeof userId !== 'undefined' ? userId : 'TEST_USER';
        
        // Check for completed assessment first
        google.script.run
          .withSuccessHandler(function(lastResponse) {
            console.log('Last submitted response:', lastResponse);
            
            if (lastResponse && lastResponse.data) {
              // User has completed the assessment
              updateLandingPageButtons('completed', lastResponse);
            } else {
              // Check for drafts
              checkForDrafts();
            }
          })
          .withFailureHandler(function(error) {
            console.log('No completed response found, checking drafts');
            checkForDrafts();
          })
          .getLastToolResponse(currentUserId, 'tool1');
      }
      
      function checkForDrafts() {
        const currentUserId = typeof userId !== 'undefined' ? userId : 'TEST_USER';
        
        google.script.run
          .withSuccessHandler(function(drafts) {
            if (drafts && drafts.length > 0) {
              // User has drafts
              updateLandingPageButtons('draft', drafts[0]);
            } else {
              // New user
              updateLandingPageButtons('new', null);
            }
          })
          .withFailureHandler(function(error) {
            console.log('No drafts found, showing new user options');
            updateLandingPageButtons('new', null);
          })
          .getToolDraftFromProperties(currentUserId, 'tool1');
      }
      
      function updateLandingPageButtons(status, data) {
        const actionsDiv = document.querySelector('.tool-actions');
        if (!actionsDiv) return;
        
        let buttonsHtml = '';
        
        switch(status) {
          case 'new':
            // New user - start button + view last report if available
            buttonsHtml = `
              <button onclick="startTool1Form()" class="btn-primary" style="font-size: 16px; padding: 12px 30px;">
                🚀 Start Assessment
              </button>
              <button onclick="viewLastSubmission()" class="btn-secondary" style="font-size: 16px; padding: 12px 30px; margin-left: 15px;" id="view-last-report-btn">
                📊 View My Last Report
              </button>
            `;
            break;
            
          case 'draft':
            // Has draft - start + continue
            let progress = 0;
            if (data?.progress) {
              progress = typeof data.progress === 'object' ? data.progress.percentage : data.progress;
            }
            progress = Math.round(progress || 0);
            
            buttonsHtml = `
              <button onclick="startTool1Form()" class="btn-primary" style="font-size: 16px; padding: 12px 30px;">
                🚀 Start Assessment
              </button>
              <button onclick="loadMostRecentDraft()" class="btn-secondary" style="font-size: 16px; padding: 12px 30px; margin-left: 15px;">
                📂 Continue Where I Left Off
              </button>
              <button onclick="viewLastSubmission()" class="btn-secondary" style="font-size: 16px; padding: 12px 30px; margin-left: 15px;" id="view-last-report-btn">
                📊 View My Last Report
              </button>
            `;
            break;
            
          case 'completed':
            // Completed - start + view results
            buttonsHtml = `
              <button onclick="startTool1Form()" class="btn-primary" style="font-size: 16px; padding: 12px 30px;">
                🚀 Retake Assessment
              </button>
              <button onclick="viewMyResults()" class="btn-secondary" style="font-size: 16px; padding: 12px 30px; margin-left: 15px;">
                📊 View Last Report
              </button>
            `;
            break;
        }
        
        actionsDiv.innerHTML = buttonsHtml;
        
        // Check if user has previous reports and hide/show View Last Report button accordingly
        checkAndToggleViewReportButton();
      }
      
      // Quick load most recent draft
      window.loadMostRecentDraft = async function() {
        const currentUserId = typeof userId !== 'undefined' ? userId : 'TEST_USER';
        console.log('🔄 loadMostRecentDraft called for:', currentUserId);
        
        try {
          // Use batched API service to get drafts
          console.log('📞 Calling ApiUtils.getToolDraft...');
          const drafts = await ApiUtils.getToolDraft(currentUserId, 'tool1');
          console.log('📥 Received drafts data:', drafts);
          console.log('📊 Drafts type:', typeof drafts, 'Array?', Array.isArray(drafts), 'Length:', drafts?.length);
          
          if (drafts && Array.isArray(drafts) && drafts.length > 0) {
            console.log('✅ Found', drafts.length, 'drafts, loading first one:', drafts[0]);
            // Load the most recent draft (first in array) and auto-navigate to form
            loadSpecificDraft(drafts[0]);
          } else {
            console.log('❌ No valid drafts found. Data received:', drafts);
            alert('No draft found to load.');
          }
        } catch (error) {
          console.error('❌ Error loading recent draft (batched):', error);
          console.error('Error details:', error.message, error.stack);
          
          // Fallback to direct API call
          console.log('🔄 Trying fallback to direct API call...');
          try {
            google.script.run
              .withSuccessHandler(function(drafts) {
                console.log('✅ Fallback API success:', drafts);
                if (drafts && drafts.length > 0) {
                  loadSpecificDraft(drafts[0]);
                } else {
                  alert('No draft found to load.');
                }
              })
              .withFailureHandler(function(error) {
                console.error('❌ Fallback API also failed:', error);
                alert('Error loading draft. Please try again.');
              })
              .getToolDraftFromProperties(currentUserId, 'tool1');
          } catch (fallbackError) {
            console.error('❌ Fallback also failed:', fallbackError);
            alert('Error loading draft. Please try again.');
          }
        }
      }
      
      // View completed results (fixed to use working viewLastSubmission function)
      window.viewMyResults = function() {
        // Simply call our working viewLastSubmission function
        viewLastSubmission();
      }
      
      // Check if user has previous reports and toggle View Last Report button visibility
      async function checkAndToggleViewReportButton() {
        const viewReportBtn = document.getElementById('view-last-report-btn');
        if (!viewReportBtn) return;
        
        const currentUserId = typeof userId !== 'undefined' ? userId : 'TEST_USER';
        
        try {
          // Use batched API service to check for submissions
          const lastSubmission = await ApiUtils.getLastSubmission(currentUserId, 'tool1');
          
          if (viewReportBtn) {
            if (lastSubmission && lastSubmission.data) {
              viewReportBtn.style.display = 'inline-block';
            } else {
              viewReportBtn.style.display = 'none';
            }
          }
        } catch (error) {
          console.log('❌ No previous reports found or error checking (batched):', error);
          if (viewReportBtn) {
            viewReportBtn.style.display = 'none';
          }
        }
      }
      
      // Load a specific draft and switch to form view
      function loadSpecificDraft(draft) {
        // Switch to form view first
        startTool1Form();
        
        // Then load the draft data
        setTimeout(() => {
          if (draft && draft.data) {
            restoreFormData(draft.data);
            console.log('Loaded draft with', draft.progress, '% completion');
          }
        }, 100);
      }
      
      // Show completed report
      function showCompletedReport(report) {
        // Switch to the report view
        const landingDiv = document.getElementById('tool1-landing');
        const formDiv = document.getElementById('tool1-form');
        
        if (landingDiv) landingDiv.style.display = 'none';
        if (formDiv) formDiv.style.display = 'none';
        
        // Create or show report div
        let reportDiv = document.getElementById('insights-report');
        if (!reportDiv) {
          reportDiv = document.createElement('div');
          reportDiv.id = 'insights-report';
          document.getElementById('tool-content').appendChild(reportDiv);
        }
        
        reportDiv.style.display = 'block';
        
        // Display the report (reuse existing report generation)
        const reportHtml = generateReportHTML(report);
        reportDiv.innerHTML = reportHtml;
        
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
      
      window.selectDraftVersion = function(index) {
        if (!window.availableDrafts || !window.availableDrafts[index]) {
          console.error('Invalid draft selection');
          return;
        }
        
        const selectedDraft = window.availableDrafts[index];
        console.log('Selected draft:', selectedDraft);
        
        // Use ToolWrapper to restore the draft
        if (typeof ToolWrapper !== 'undefined' && ToolWrapper.restoreDraft) {
          ToolWrapper.restoreDraft(selectedDraft);
        } else {
          // Fallback: manually restore form data
          if (selectedDraft.data) {
            Object.keys(selectedDraft.data).forEach(key => {
              const element = document.querySelector(`[name="${key}"]`);
              if (element) {
                if (element.type === 'checkbox' || element.type === 'radio') {
                  element.checked = element.value === selectedDraft.data[key];
                } else {
                  element.value = selectedDraft.data[key];
                }
              }
            });
          }
        }
        
        closeDraftModal();
        
        // Show notification
        const notification = document.createElement('div');
        notification.className = 'notification notification-success show';
        notification.innerHTML = '<div class="notification-content">✅ Draft loaded successfully</div>';
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
      }
      
      // Load Comprehensive Orientation Tool (25 Questions)
      window.loadOrientationTool = function() {
        // Check if ToolWrapper is available
        if (typeof ToolWrapper !== 'undefined') {
          // Use the new wrapper system
          const wrapperHtml = ToolWrapper.init('tool1');
          document.getElementById('tool-container').innerHTML = wrapperHtml;
          
          // Create the tool content (landing + form)
          const toolContent = `
            <div class="tool-landing" id="tool1-landing">
              <p style="color: var(--muted); font-size: 16px; margin: 20px 0;">
                Complete this comprehensive assessment to receive your personalized Financial Health Score, 
                profile type, and customized recommendations.
              </p>
              
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 30px 0;">
                <div class="card" style="text-align: left;">
                  <h4 style="color: var(--gold);">📊 What You'll Discover</h4>
                  <ul style="color: var(--muted); font-size: 14px;">
                    <li>Financial Health Score (0-100)</li>
                    <li>Money Mindset Analysis</li>
                    <li>Personalized Profile Type</li>
                    <li>Custom Recommendations</li>
                  </ul>
                </div>
                <div class="card" style="text-align: left;">
                  <h4 style="color: var(--gold);">⏱️ Assessment Overview</h4>
                  <ul style="color: var(--muted); font-size: 14px;">
                    <li>25+ comprehensive questions</li>
                    <li>5 sections to complete</li>
                    <li>Auto-saves every 2 minutes</li>
                    <li>About 20 minutes total</li>
                  </ul>
                </div>
              </div>
              
              <div class="tool-actions">
                <button onclick="startTool1Form()" class="btn-primary" style="font-size: 16px; padding: 12px 30px;">
                  🚀 Start Assessment
                </button>
                <button onclick="ToolWrapper.showLoadOptions()" class="btn-secondary" id="continue-draft-btn" style="display:none;">
                  📂 Continue Previous
                </button>
              </div>
            </div>
            
            <div id="tool1-form" style="display:none;">
              ${getOrientationFormHTML()}
            </div>
          `;
          
          document.getElementById('tool-content').innerHTML = toolContent;
          
          // Check user status and update landing page accordingly
          checkUserStatusAndUpdateLanding();
          
        } else {
          // Fallback to legacy version without wrapper
          loadOrientationToolLegacy();
        }
      }
      
      // Get the orientation form HTML (extracted for clarity)
      window.getOrientationFormHTML = function() {
        return `
          <h2>📋 Comprehensive Financial Profile Assessment</h2>
          <div class="hr"></div>
          <p class="muted" style="margin-bottom: 20px;">
            All 25 questions help us understand your complete situation.
          
          <!-- Progress Bar -->
          <div style="margin-bottom: 25px;">
            <div style="background: rgba(173, 145, 104, 0.2); border-radius: 20px; height: 8px; overflow: hidden;">
              <div id="progress-bar" style="background: var(--gold); height: 100%; width: 20%; transition: width 0.3s;"></div>
            </div>
            <p class="muted" style="text-align: center; margin-top: 8px;">Section 1 of 5</p>
          </div>
          
          <!-- Navigation Section -->
          <div style="margin-bottom: 20px; padding: 15px; background: rgba(173, 145, 104, 0.05); border-radius: 10px; border: 1px solid rgba(173, 145, 104, 0.2);">
            <button type="button" class="btn btn-secondary" onclick="viewLastSubmission()">
              📊 View Last Report
            </button>
          </div>
          
          <form id="tool-form" data-tool-id="tool1" onsubmit="saveOrientationData(event)">
            <!-- Section 1: Basic Information -->
            <div data-section="1" style="background: linear-gradient(315deg, rgba(173, 145, 104, 0.1) 0%, rgba(30, 25, 43, 0.2) 100%); border-radius: 15px; padding: 20px; margin-bottom: 25px;">
              <h3 style="font-size: 18px; margin-bottom: 15px; color: var(--gold);">👤 Basic Information</h3>
              <div class="form-grid">
                <div>
                  <label class="form-label">First Name *</label>
                  <input type="text" name="firstName" required class="form-input" placeholder="John">
                </div>
                
                <div>
                  <label class="form-label">Last Name *</label>
                  <input type="text" name="lastName" required class="form-input" placeholder="Doe">
                </div>
                
                <div>
                  <label class="form-label">Email Address *</label>
                  <input type="email" name="email" required class="form-input" placeholder="john@example.com">
                </div>
                
                <div>
                  <label class="form-label">Age *</label>
                  <input type="number" name="age" min="18" max="100" required class="form-input" placeholder="35">
                </div>
                
                <div>
                  <label class="form-label">Marital Status *</label>
                  <select name="maritalStatus" required class="form-select">
                    <option value="">Select...</option>
                    <option value="single">Single</option>
                    <option value="married">Married</option>
                    <option value="divorced">Divorced</option>
                    <option value="widowed">Widowed</option>
                  </select>
                </div>
                
                <div>
                  <label class="form-label">Employment Status *</label>
                  <select name="employmentStatus" required class="form-select">
                    <option value="">Select...</option>
                    <option value="employed-ft">Employed Full-Time</option>
                    <option value="employed-pt">Employed Part-Time</option>
                    <option value="self-employed">Self-Employed</option>
                    <option value="unemployed">Unemployed</option>
                    <option value="retired">Retired</option>
                  </select>
                </div>
                
                <div>
                  <label class="form-label">Number of Dependents *</label>
                  <input type="number" name="dependents" min="0" max="10" required class="form-input" placeholder="0">
                </div>
              </div>
            </div>
            
            <!-- Section 2: Employment & Income -->
            <div data-section="2" style="background: linear-gradient(315deg, rgba(173, 145, 104, 0.1) 0%, rgba(30, 25, 43, 0.2) 100%); border-radius: 15px; padding: 20px; margin-bottom: 25px;">
              <h3 style="font-size: 18px; margin-bottom: 15px; color: var(--gold);">💼 Employment & Income</h3>
              <div class="form-grid">
                <div>
                  <label class="form-label">Industry/Profession</label>
                  <input type="text" name="profession" class="form-input" placeholder="e.g., Teacher">
                </div>
                
                <div>
                  <label class="form-label">Years at Current Job</label>
                  <input type="number" name="yearsEmployed" min="0" max="50" class="form-input" placeholder="5">
                </div>
                
                <div>
                  <label class="form-label">Other Income Sources</label>
                  <input type="number" name="otherIncome" min="0" class="form-input" placeholder="0">
                </div>
                
                <div>
                  <label class="form-label">401k/Retirement Access *</label>
                  <select name="retirementAccess" required class="form-select">
                    <option value="">Select...</option>
                    <option value="401k-match">401k with Match</option>
                    <option value="401k-no-match">401k No Match</option>
                    <option value="none">No Workplace Retirement</option>
                  </select>
                </div>
              </div>
            </div>
            
            <!-- Section 3: Financial Snapshot -->
            <div data-section="3" style="background: linear-gradient(315deg, rgba(173, 145, 104, 0.1) 0%, rgba(30, 25, 43, 0.2) 100%); border-radius: 15px; padding: 20px; margin-bottom: 25px;">
              <h3 style="font-size: 18px; margin-bottom: 15px; color: var(--gold);">💰 Financial Snapshot</h3>
              <div class="form-grid">
                <div>
                  <label class="form-label">Annual Household Income *</label>
                  <select name="annualIncome" required class="form-select">
                    <option value="">Select...</option>
                    <option value="< $30,000">Under $30,000</option>
                    <option value="$30,000-$50,000">$30,000 - $50,000</option>
                    <option value="$50,000-$75,000">$50,000 - $75,000</option>
                    <option value="$75,000-$100,000">$75,000 - $100,000</option>
                    <option value="$100,000-$150,000">$100,000 - $150,000</option>
                    <option value="> $150,000">Over $150,000</option>
                  </select>
                </div>
                
                <div>
                  <label class="form-label">Monthly Housing Cost *</label>
                  <input type="number" name="housingCost" min="0" required class="form-input" placeholder="1500">
                </div>
                
                <div>
                  <label class="form-label">Total Monthly Expenses *</label>
                  <input type="number" name="monthlyExpenses" min="0" required class="form-input" placeholder="3500">
                </div>
                
                <div>
                  <label class="form-label">Monthly Savings *</label>
                  <input type="number" name="monthlySavings" min="0" required class="form-input" placeholder="500">
                </div>
                
                <div>
                  <label class="form-label">Total Debt (excluding mortgage) *</label>
                  <select name="totalDebt" required class="form-select">
                    <option value="">Select...</option>
                    <option value="None">$0 (Debt Free)</option>
                    <option value="< $10,000">Under $10,000</option>
                    <option value="$10,000-$25,000">$10,000 - $25,000</option>
                    <option value="$25,000-$50,000">$25,000 - $50,000</option>
                    <option value="$50,000-$100,000">$50,000 - $100,000</option>
                    <option value="> $100,000">Over $100,000</option>
                  </select>
                </div>
                
                <div>
                  <label class="form-label">Emergency Fund Status *</label>
                  <select name="emergencyFund" required class="form-select">
                    <option value="">Select...</option>
                    <option value="None">No Emergency Fund</option>
                    <option value="< 1 month">Less than 1 Month</option>
                    <option value="1-3 months">1-3 Months</option>
                    <option value="3-6 months">3-6 Months</option>
                    <option value="> 6 months">More than 6 Months</option>
                  </select>
                </div>
                
                <div>
                  <label class="form-label">Current Total Savings</label>
                  <input type="number" name="currentSavings" min="0" class="form-input" placeholder="5000">
                </div>
                
                <div>
                  <label class="form-label">Investment Experience *</label>
                  <select name="investmentExperience" required class="form-select">
                    <option value="">Select...</option>
                    <option value="none">No Experience</option>
                    <option value="beginner">Beginner</option>
                    <option value="intermediate">Intermediate</option>
                    <option value="experienced">Experienced</option>
                  </select>
                </div>
                
                <div>
                  <label class="form-label">Primary Financial Goal *</label>
                  <select name="primaryGoal" required class="form-select">
                    <option value="">Select...</option>
                    <option value="Eliminate Debt">Eliminate Debt</option>
                    <option value="Build Emergency Fund">Build Emergency Fund</option>
                    <option value="Save for Retirement">Save for Retirement</option>
                    <option value="Buy a Home">Buy a Home</option>
                    <option value="Start a Business">Start a Business</option>
                    <option value="Save for Education">Save for Education</option>
                    <option value="Build Wealth">Build Wealth</option>
                    <option value="Financial Independence">Financial Independence</option>
                  </select>
                </div>
                
                <div>
                  <label class="form-label">Target Retirement Age</label>
                  <input type="number" name="retirementTarget" min="50" max="80" class="form-input" placeholder="65">
                </div>
                
                <div>
                  <label class="form-label">Biggest Financial Concern *</label>
                  <select name="biggestFinancialConcern" required class="form-select">
                    <option value="">Select...</option>
                    <option value="Lack of Income">Lack of Income</option>
                    <option value="Too Much Debt">Too Much Debt</option>
                    <option value="No Clear Plan">No Clear Plan</option>
                    <option value="Lack of Knowledge">Lack of Knowledge</option>
                    <option value="Fear/Anxiety">Fear/Anxiety</option>
                    <option value="Lack of Discipline">Lack of Discipline</option>
                    <option value="Market Volatility">Market Volatility</option>
                    <option value="Family Obligations">Family Obligations</option>
                  </select>
                </div>
              </div>
            </div>
            
            <!-- Section 4: Mindset Assessment (Scored -3 to +3) -->
            <div data-section="4" style="background: linear-gradient(315deg, rgba(173, 145, 104, 0.1) 0%, rgba(30, 25, 43, 0.2) 100%); border-radius: 15px; padding: 20px; margin-bottom: 25px;">
              <h3 style="font-size: 18px; margin-bottom: 15px; color: var(--gold);">🧠 Mindset Assessment</h3>
              <p class="muted" style="margin-bottom: 20px; font-size: 13px;">Move the sliders to indicate where you fall on each scale</p>
              
              <div style="margin-bottom: 25px;">
                <label class="form-label">How would you describe your current Financial Situation? *</label>
                <input type="range" name="financialSituation" min="-3" max="3" value="0" required 
                       oninput="updateScaleLabel(this, 'financial-situation')" style="width: 100%;">
                <div id="financial-situation-label" style="text-align: center; margin-top: 10px; color: var(--gold);">
                  Okay (0)
                </div>
                <div class="muted" style="font-size: 11px; display: flex; justify-content: space-between; margin-top: 5px;">
                  <span>-3: Horrible</span>
                  <span>0: Okay</span>
                  <span>+3: Great</span>
                </div>
              </div>
              
              <div style="margin-bottom: 25px;">
                <label class="form-label">Your relationship with Money? *</label>
                <input type="range" name="moneyRelationship" min="-3" max="3" value="0" required 
                       oninput="updateScaleLabel(this, 'money-relationship')" style="width: 100%;">
                <div id="money-relationship-label" style="text-align: center; margin-top: 10px; color: var(--gold);">
                  Okay (0)
                </div>
                <div class="muted" style="font-size: 11px; display: flex; justify-content: space-between; margin-top: 5px;">
                  <span>-3: Combat</span>
                  <span>0: Okay</span>
                  <span>+3: Great</span>
                </div>
              </div>
              
              <div style="margin-bottom: 25px;">
                <label class="form-label">Financial Scarcity vs Abundance Mindset? *</label>
                <input type="range" name="scarcityAbundance" min="-3" max="3" value="0" required 
                       oninput="updateScaleLabel(this, 'scarcity-abundance')" style="width: 100%;">
                <div id="scarcity-abundance-label" style="text-align: center; margin-top: 10px; color: var(--gold);">
                  Balanced (0)
                </div>
                <div class="muted" style="font-size: 11px; display: flex; justify-content: space-between; margin-top: 5px;">
                  <span>-3: Full Scarcity</span>
                  <span>0: Balanced</span>
                  <span>+3: Full Abundance</span>
                </div>
              </div>
              
              <div style="margin-bottom: 25px;">
                <label class="form-label">Confidence in reaching your financial goals? *</label>
                <input type="range" name="goalConfidence" min="-3" max="3" value="0" required 
                       oninput="updateScaleLabel(this, 'goal-confidence')" style="width: 100%;">
                <div id="goal-confidence-label" style="text-align: center; margin-top: 10px; color: var(--gold);">
                  Maybe (0)
                </div>
                <div class="muted" style="font-size: 11px; display: flex; justify-content: space-between; margin-top: 5px;">
                  <span>-3: No Chance</span>
                  <span>0: Maybe</span>
                  <span>+3: Certain</span>
                </div>
              </div>
              
              <div style="margin-bottom: 25px;">
                <label class="form-label">What is your level of Financial Ambition? *</label>
                <input type="range" name="financialAmbition" min="-3" max="3" value="0" required 
                       oninput="updateScaleLabel(this, 'financial-ambition')" style="width: 100%;">
                <div id="financial-ambition-label" style="text-align: center; margin-top: 10px; color: var(--gold);">
                  Comfort (0)
                </div>
                <div class="muted" style="font-size: 11px; display: flex; justify-content: space-between; margin-top: 5px;">
                  <span>-3: Survival Mode</span>
                  <span>0: Comfort</span>
                  <span>+3: Financial Freedom</span>
                </div>
              </div>
            </div>
            
            <!-- Section 5: Goals & Planning -->
            <div data-section="5" style="background: linear-gradient(315deg, rgba(173, 145, 104, 0.1) 0%, rgba(30, 25, 43, 0.2) 100%); border-radius: 15px; padding: 20px; margin-bottom: 25px;">
              <h3 style="font-size: 18px; margin-bottom: 15px; color: var(--gold);">🎯 Goals & Planning</h3>
              <div style="margin-bottom: 20px;">
                <label class="form-label">Target Retirement Age</label>
                <input type="number" name="retirementAge" min="30" max="100" class="form-input" placeholder="65">
              </div>
              
              <div>
                <label class="form-label">What is your BIGGEST financial obstacle? *</label>
                <textarea name="biggestObstacle" required class="form-input" rows="3" 
                          placeholder="What's the main thing holding you back financially?" 
                          style="border-radius: 15px; resize: vertical; width: 100%;"></textarea>
              </div>
            </div>
            
            <div style="margin-top: 30px; text-align: center;">
              <!-- Draft management buttons -->
              <div style="margin-bottom: 20px;">
                <button type="button" class="btn btn-secondary" onclick="ToolWrapper.showLoadOptions()" style="margin-right: 10px;">
                  📂 Load Draft
                </button>
                <button type="button" class="btn btn-secondary" onclick="ToolWrapper.saveDraft()">
                  💾 Save Progress
                </button>
              </div>
              <!-- Submit button -->
              <button type="submit" class="btn" style="min-width: 250px;">
                📊 Generate My Personalized Insights Report
              </button>
            </div>
          </form>
          
          <!-- Insights Report Display (Hidden initially) -->
          <div id="insights-report" style="display: none;"></div>
        `;
      }
      
      // Legacy function without wrapper (fallback)
      window.loadOrientationToolLegacy = function() {
        const html = getOrientationFormHTML();
        document.getElementById('tool-container').innerHTML = html;
      }
      
      // Update scale label helper
      window.updateScaleLabel = function(input, labelType) {
        const value = parseInt(input.value);
        const label = document.getElementById(labelType + '-label');
        
        const labels = {
          'financial-situation': [
            'Horrible and getting worse (-3)',
            'Bad but stable (-2)',
            'Not where I want it (-1)',
            'Okay (0)',
            'Bad but hopeful (+1)',
            'Good and improving (+2)',
            'Great and stable (+3)'
          ],
          'money-relationship': [
            'Constant combat (-3)',
            'Consistent fear (-2)',
            'Troubled (-1)',
            'Okay (0)',
            'Pretty good (+1)',
            'Good (+2)',
            'Great (+3)'
          ],
          'scarcity-abundance': [
            'Full scarcity (-3)',
            'Mostly scarcity (-2)',
            'Some scarcity (-1)',
            'Balanced (0)',
            'Some abundance (+1)',
            'Mostly abundance (+2)',
            'Full abundance (+3)'
          ],
          'goal-confidence': [
            'Not a chance (-3)',
            'Very unlikely (-2)',
            'Unlikely (-1)',
            'Maybe (0)',
            'Likely (+1)',
            'Very likely (+2)',
            'Absolutely certain (+3)'
          ],
          'financial-ambition': [
            'Survival mode (-3)',
            'Getting by (-2)',
            'Stability (-1)',
            'Comfort (0)',
            'Growth (+1)',
            'Wealth building (+2)',
            'Financial freedom (+3)'
          ]
        };
        
        if (labels[labelType]) {
          label.textContent = labels[labelType][value + 3];
          // Color code based on value
          if (value < 0) {
            label.style.color = 'var(--bad)';
          } else if (value > 0) {
            label.style.color = 'var(--ok)';
          } else {
            label.style.color = 'var(--gold)';
          }
        }
      }
      
      // Wrapper function to bridge V10 pattern with existing logic
      window.submitForm = function(event) {
        // Call the existing function that has all the scoring logic
        return saveOrientationData(event);
      }
      
      // Save Orientation Data and Generate Insights Report
      window.saveOrientationData = function(event) {
        event.preventDefault();
        event.stopPropagation();
        
        console.log('saveOrientationData called');
        
        const form = event.target;
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);
        
        console.log('Form data collected:', data);
        
        // Show saving state
        const button = form.querySelector('button[type="submit"]');
        button.disabled = true;
        button.textContent = 'Analyzing your profile...';
        
        // Generate the report immediately while saving in background
        const report = generateLocalInsightsReport(data);
        console.log('Report generated:', report);
        
        // Display the report immediately
        displayInsightsReport(report);
        
        // Save data in background
        google.script.run
          .withSuccessHandler(function(result) {
            console.log('Save result:', result);
            // Add any server insights if available
            if (result && result.insights && result.insights.length > 0) {
              report.serverInsights = result.insights;
              // Update display with server insights
              displayInsightsReport(report);
            }
          })
          .withFailureHandler(function(error) {
            console.error('Save error:', error);
            // Still show the report even if save fails
            alert('Note: Data save failed but your report is displayed. Error: ' + error);
          })
          .saveUserData(userId, 'tool1', data);
          
        return false; // Prevent form submission
      }
      
      // Generate Insights Report Locally
      window.generateLocalInsightsReport = function(data) {
        // Calculate Financial Health Score (0-100)
        let healthScore = 50; // Base score
        
        // Financial situation contributes
        healthScore += (parseInt(data.financialSituation) || 0) * 10;
        
        // Debt level impacts score (now handles string values)
        const debtValue = data.totalDebt || 'None';
        if (debtValue === 'None') healthScore += 15;
        else if (debtValue === '< $10,000') healthScore += 5;
        else if (debtValue === '$10,000-$25,000') healthScore -= 5;
        else if (debtValue === '$25,000-$50,000') healthScore -= 10;
        else if (debtValue === '$50,000-$100,000') healthScore -= 15;
        else if (debtValue === '> $100,000') healthScore -= 20;
        
        // Emergency fund impacts score (now handles string values)
        const emergencyValue = data.emergencyFund || 'None';
        if (emergencyValue === 'None') healthScore -= 15;
        else if (emergencyValue === '< 1 month') healthScore -= 5;
        else if (emergencyValue === '1-3 months') healthScore += 5;
        else if (emergencyValue === '3-6 months') healthScore += 10;
        else if (emergencyValue === '> 6 months') healthScore += 15;
        
        // Annual income impacts score
        const incomeValue = data.annualIncome || '< $30,000';
        if (incomeValue === '< $30,000') healthScore -= 10;
        else if (incomeValue === '$30,000-$50,000') healthScore -= 5;
        else if (incomeValue === '$50,000-$75,000') healthScore += 0;
        else if (incomeValue === '$75,000-$100,000') healthScore += 5;
        else if (incomeValue === '$100,000-$150,000') healthScore += 10;
        else if (incomeValue === '> $150,000') healthScore += 15;
        
        // Money relationship
        healthScore += (parseInt(data.moneyRelationship) || 0) * 3;
        
        // Ensure score is 0-100
        healthScore = Math.max(0, Math.min(100, healthScore));
        
        // Calculate Mindset Score (now includes financialAmbition)
        const mindsetScore = 
          (parseInt(data.scarcityAbundance) || 0) + 
          (parseInt(data.goalConfidence) || 0) + 
          (parseInt(data.moneyRelationship) || 0) + 
          (parseInt(data.financialAmbition) || 0) / 2;  // Average the 4 mindset fields
        
        // Determine profile type
        let profile = {};
        if (healthScore >= 70 && mindsetScore >= 3) {
          profile = {
            type: 'Thriving Optimizer',
            emoji: '🚀',
            message: 'You are in a strong financial position with an abundance mindset',
            focus: 'Focus on wealth multiplication and advanced strategies'
          };
        } else if (healthScore >= 70 && mindsetScore < 3) {
          profile = {
            type: 'Cautious Success',
            emoji: '🛡️',
            message: 'Financially stable but held back by limiting beliefs',
            focus: 'Work on aligning your mindset with your financial reality'
          };
        } else if (healthScore >= 40 && mindsetScore >= 0) {
          profile = {
            type: 'Emerging Builder',
            emoji: '🌱',
            message: 'You are on the right path with room to grow',
            focus: 'Focus on systematic improvement and building confidence'
          };
        } else if (healthScore < 40 && mindsetScore >= 0) {
          profile = {
            type: 'Optimistic Striver',
            emoji: '💪',
            message: 'Your positive mindset is your greatest asset',
            focus: 'Channel your optimism into concrete financial actions'
          };
        } else {
          profile = {
            type: 'Foundation Builder',
            emoji: '🏗️',
            message: 'You are ready to build from the ground up',
            focus: 'Start with basics and celebrate small wins to build momentum'
          };
        }
        
        return { healthScore, mindsetScore, profile, data };
      }
      
      // Display the Insights Report
      window.displayInsightsReport = function(report) {
        // Store report data for download function
        window.lastGeneratedReport = report;
        
        const reportHtml = `
          <div style="animation: fadeIn 0.5s;">
            <h2>📊 Your Personalized Financial Insights Report</h2>
            <div class="hr"></div>
            
            <!-- Profile Type Card -->
            <div class="card" style="text-align: center; background: linear-gradient(135deg, rgba(173, 145, 104, 0.2) 0%, rgba(30, 25, 43, 0.4) 100%);">
              <div style="font-size: 60px; margin-bottom: 20px;">${report.profile.emoji}</div>
              <h3 style="font-size: 28px; margin-bottom: 10px; color: var(--gold);">
                ${report.profile.type}
              </h3>
              <p style="font-size: 16px; margin-bottom: 15px;">${report.profile.message}</p>
              <p class="muted">${report.profile.focus}</p>
            </div>
            
            <!-- Scores Grid -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
              <div class="card" style="text-align: center;">
                <h4 style="color: var(--gold); margin-bottom: 10px;">Financial Health Score</h4>
                <div style="font-size: 48px; font-weight: bold; color: ${report.healthScore >= 70 ? 'var(--ok)' : report.healthScore >= 40 ? 'var(--gold)' : 'var(--bad)'};">
                  ${report.healthScore}
                </div>
                <p class="muted">out of 100</p>
              </div>
              
              <div class="card" style="text-align: center;">
                <h4 style="color: var(--gold); margin-bottom: 10px;">Mindset Score</h4>
                <div style="font-size: 48px; font-weight: bold; color: ${report.mindsetScore >= 3 ? 'var(--ok)' : report.mindsetScore >= 0 ? 'var(--gold)' : 'var(--bad)'};">
                  ${report.mindsetScore > 0 ? '+' : ''}${report.mindsetScore}
                </div>
                <p class="muted">range: -9 to +9</p>
              </div>
            </div>
            
            <!-- Key Insights -->
            <div class="card" style="margin-top: 20px;">
              <h4 style="color: var(--gold); margin-bottom: 15px;">🔍 Key Insights for You</h4>
              <ul style="list-style: none; padding: 0;">
                ${report.healthScore < 40 ? '<li style="margin-bottom: 10px;">⚠️ <strong>Immediate attention needed:</strong> Focus on emergency savings and debt reduction</li>' : ''}
                ${report.data.totalDebt > 50000 ? '<li style="margin-bottom: 10px;">💰 <strong>High debt burden:</strong> Prioritize debt elimination strategies</li>' : ''}
                ${report.data.emergencyFund == 0 ? '<li style="margin-bottom: 10px;">🚨 <strong>No emergency fund:</strong> Start with $1,000 emergency fund immediately</li>' : ''}
                ${report.mindsetScore < 0 ? '<li style="margin-bottom: 10px;">🧠 <strong>Mindset barriers detected:</strong> Your beliefs about money need attention</li>' : ''}
                ${report.mindsetScore >= 6 ? '<li style="margin-bottom: 10px;">✨ <strong>Exceptional mindset:</strong> Your positive outlook is a major advantage</li>' : ''}
                <li style="margin-bottom: 10px;">📈 <strong>Next focus:</strong> ${report.data.primaryGoal === 'retirement' ? 'Retirement planning tools will be crucial' : report.data.primaryGoal === 'debt' ? 'Debt elimination should be your priority' : 'Building financial foundations'}</li>
              </ul>
            </div>
            
            <!-- Action Plan -->
            <div class="card" style="margin-top: 20px;">
              <h4 style="color: var(--gold); margin-bottom: 15px;">📋 Your Personalized Action Plan</h4>
              <ol style="padding-left: 20px; line-height: 1.8;">
                <li>Complete Tool 2: Financial Clarity (Week 2) for detailed assessment</li>
                ${report.mindsetScore < 0 ? '<li>Focus on Tool 3: Control Fear Grounding (Week 3) for mindset work</li>' : ''}
                ${report.data.primaryGoal === 'retirement' ? '<li>Prioritize Tools 6 & 8 for retirement planning</li>' : ''}
                ${report.data.emergencyFund == 0 ? '<li>Start building $1,000 emergency fund this month</li>' : ''}
                <li>Review this report weekly and track progress</li>
              </ol>
            </div>
            
            <!-- Financial Clarity Prep Work -->
            <div class="card" style="margin-top: 20px; background: linear-gradient(135deg, rgba(24, 139, 246, 0.1) 0%, rgba(173, 145, 104, 0.1) 100%);">
              <h4 style="color: var(--gold); margin-bottom: 15px;">📝 Your Homework: Prepare for Tool 2 - Financial Clarity</h4>
              <p class="muted" style="margin-bottom: 15px;">Tool 2 will deep-dive into your finances. Based on your profile, prioritize gathering this information:</p>
              
              ${report.healthScore < 40 || report.data.totalDebt > 25000 ? `
                <div style="margin-bottom: 20px;">
                  <h5 style="color: var(--bad); margin-bottom: 10px;">🔴 Priority 1: Debt Documentation (Critical for You)</h5>
                  <ul style="list-style: none; padding-left: 0;">
                    <li>☐ List ALL debts: credit cards, loans, medical, personal</li>
                    <li>☐ For each debt, write down: Balance, Interest Rate, Minimum Payment</li>
                    <li>☐ Calculate total minimum monthly debt payments</li>
                    <li>☐ Identify highest interest rate debt</li>
                  </ul>
                </div>
              ` : ''}
              
              ${report.data.emergencyFund <= 1 || report.healthScore < 50 ? `
                <div style="margin-bottom: 20px;">
                  <h5 style="color: var(--warn); margin-bottom: 10px;">🟡 Priority ${report.data.totalDebt > 25000 ? '2' : '1'}: Expense Tracking (Important for You)</h5>
                  <ul style="list-style: none; padding-left: 0;">
                    <li>☐ List all monthly fixed expenses (rent, insurance, subscriptions)</li>
                    <li>☐ Track this week's variable spending (food, gas, entertainment)</li>
                    <li>☐ Identify your 3 biggest expense categories</li>
                    <li>☐ Find 3 expenses you could reduce or eliminate</li>
                  </ul>
                </div>
              ` : ''}
              
              ${report.data.annualIncome && parseInt(report.data.annualIncome) > 0 ? `
                <div style="margin-bottom: 20px;">
                  <h5 style="color: var(--ok); margin-bottom: 10px;">🟢 Priority ${report.healthScore < 40 ? '3' : '2'}: Income & Assets Review</h5>
                  <ul style="list-style: none; padding-left: 0;">
                    <li>☐ Gather last 2 pay stubs</li>
                    <li>☐ List all income sources and amounts</li>
                    <li>☐ Check all account balances (checking, savings, retirement)</li>
                    <li>☐ Note any expected income changes in next 6 months</li>
                  </ul>
                </div>
              ` : ''}
              
              ${report.data.primaryGoal === 'retirement' || report.data.retirementAccess !== 'none' ? `
                <div style="margin-bottom: 20px;">
                  <h5 style="color: var(--gold); margin-bottom: 10px;">✨ Bonus: Retirement Account Review</h5>
                  <ul style="list-style: none; padding-left: 0;">
                    <li>☐ Find your 401k/IRA balance and contribution rate</li>
                    <li>☐ Check if you're getting full employer match</li>
                    <li>☐ Calculate years until retirement goal</li>
                  </ul>
                </div>
              ` : ''}
              
              <div style="background: rgba(173, 145, 104, 0.1); border-radius: 10px; padding: 15px; margin-top: 15px;">
                <p style="margin: 0; font-size: 14px;">
                  <strong>💡 Pro Tip:</strong> ${
                    report.healthScore < 40 ? 
                    'Focus on the debt documentation first - this will be crucial for creating your debt elimination strategy.' :
                    report.data.emergencyFund == 0 ?
                    'Tracking expenses this week will reveal where your emergency fund money can come from.' :
                    'Having these numbers ready will make Tool 2 much more powerful and actionable for you.'
                  }
                </p>
              </div>
            </div>
            
            <!-- Next Steps -->
            <div style="text-align: center; margin-top: 30px;">
              <button onclick="downloadReport(event)" class="btn" style="margin-right: 10px; background: linear-gradient(135deg, #AD9168 0%, #8B7355 100%); color: #1e1933 !important;">
                📥 Download Report (PDF)
              </button>
              <button onclick="window.print()" class="btn" style="margin-right: 10px; background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%); color: white !important;">
                🖨️ Print Report
              </button>
              ${currentWeek >= 2 ? `
                <button onclick="loadTool('financial-clarity')" class="btn" style="margin-right: 10px;">
                  Continue to Tool 2
                </button>
              ` : ''}
              <button onclick="navigateBackToDashboard()" class="btn-secondary" style="background: var(--card-bg); color: var(--text);">
                Return to Dashboard
              </button>
            </div>
          </div>
        `;
        
        document.getElementById('tool-container').innerHTML = reportHtml;
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
      
      // Download report function - generates PDF server-side
      window.downloadReport = function(event) {
        const reportData = window.lastGeneratedReport;
        if (!reportData) {
          alert('No report available to download');
          return;
        }
        
        // Show loading state
        const downloadBtn = event ? event.target : document.querySelector('button[onclick*="downloadReport"]');
        const originalText = downloadBtn.textContent;
        downloadBtn.textContent = '⏳ Generating PDF...';
        downloadBtn.disabled = true;
        
        // Call server to generate PDF
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              // Convert base64 to blob
              const byteCharacters = atob(result.base64);
              const byteNumbers = new Array(byteCharacters.length);
              for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
              }
              const byteArray = new Uint8Array(byteNumbers);
              const blob = new Blob([byteArray], {type: result.mimeType});
              
              // Create download link
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = result.fileName;
              document.body.appendChild(a);
              a.click();
              
              // Clean up
              document.body.removeChild(a);
              window.URL.revokeObjectURL(url);
              
              console.log('PDF downloaded successfully');
            } else {
              alert('Error generating PDF: ' + (result.error || 'Unknown error'));
            }
            
            // Restore button state
            downloadBtn.textContent = originalText;
            downloadBtn.disabled = false;
          })
          .withFailureHandler(function(error) {
            alert('Error generating report: ' + error.message);
            downloadBtn.textContent = originalText;
            downloadBtn.disabled = false;
          })
          .generatePDFReport(reportData);
      }
      
      // Legacy HTML download function (kept as backup)
      window.downloadHTMLReport = function() {
        const reportData = window.lastGeneratedReport;
        if (!reportData) {
          alert('No report available to download');
          return;
        }
        
        // Create a formatted HTML document matching website theme
        const htmlContent = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Financial TruPath - Assessment Report</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Rubik:wght@300;400;500;600;700&display=swap');
    
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(180deg, #1e1933 0%, #2d2844 50%, #1e1933 100%);
      min-height: 100vh;
      color: #e2e8f0;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 40px 20px;
    }
    
    .header {
      text-align: center;
      padding: 40px;
      background: rgba(30, 25, 51, 0.8);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      border: 1px solid rgba(173, 145, 104, 0.3);
      margin-bottom: 30px;
    }
    
    .logo {
      font-family: 'Rubik', sans-serif;
      font-size: 48px;
      font-weight: 700;
      background: linear-gradient(135deg, #AD9168 0%, #8B7355 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: 4px;
      margin-bottom: 10px;
    }
    
    .subtitle {
      font-size: 35px;
      color: #94a3b8;
      letter-spacing: 3px;
      text-transform: uppercase;
      font-weight: 500;
      margin: 10px 0;
    }
    
    .profile-card {
      background: linear-gradient(135deg, rgba(173, 145, 104, 0.2) 0%, rgba(30, 25, 43, 0.4) 100%);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(173, 145, 104, 0.3);
      padding: 40px;
      border-radius: 15px;
      text-align: center;
      margin-bottom: 30px;
    }
    
    .profile-emoji {
      font-size: 80px;
      margin-bottom: 20px;
    }
    
    .profile-type {
      font-size: 32px;
      color: #AD9168;
      margin-bottom: 15px;
      font-weight: 600;
    }
    
    .scores-container {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .score-box {
      flex: 1;
      background: rgba(30, 25, 51, 0.6);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(173, 145, 104, 0.3);
      padding: 30px;
      border-radius: 15px;
      text-align: center;
    }
    
    .score-label {
      color: #AD9168;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 10px;
    }
    
    .score-value {
      font-size: 56px;
      font-weight: bold;
      margin: 15px 0;
    }
    
    .section {
      background: rgba(30, 25, 51, 0.6);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(173, 145, 104, 0.3);
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 20px;
    }
    
    .section h3 {
      color: #AD9168;
      font-size: 24px;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(173, 145, 104, 0.3);
    }
    
    .good { color: #22c55e; }
    .warning { color: #f59e0b; }
    .critical { color: #ef4444; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">FINANCIAL TRUPATH</div>
      <div class="subtitle">Assessment Report</div>
    </div>

    <div class="profile-card">
      <div class="profile-emoji">${reportData.profile.emoji || '🎯'}</div>
      <div class="profile-type">${reportData.profile.type}</div>
      <p>${reportData.profile.message}</p>
      <p style="color: #94a3b8;">${reportData.profile.focus}</p>
    </div>

    <div class="scores-container">
      <div class="score-box">
        <div class="score-label">Financial Health</div>
        <div class="score-value ${reportData.healthScore >= 70 ? 'good' : reportData.healthScore >= 40 ? 'warning' : 'critical'}">
          ${reportData.healthScore}
        </div>
      </div>
      
      <div class="score-box">
        <div class="score-label">Mindset Score</div>
        <div class="score-value ${reportData.mindsetScore >= 3 ? 'good' : reportData.mindsetScore >= 0 ? 'warning' : 'critical'}">
          ${reportData.mindsetScore > 0 ? '+' : ''}${reportData.mindsetScore}
        </div>
      </div>
    </div>

    <div class="section">
      <h3>📊 Key Insights</h3>
      ${reportData.healthScore < 40 ? '<p style="color: #ef4444;">⚠️ <strong>Immediate attention needed:</strong> Your financial health score indicates areas requiring urgent focus.</p>' : ''}
      ${reportData.mindsetScore < 0 ? '<p style="color: #f59e0b;">🧠 <strong>Mindset barriers detected:</strong> Your beliefs about money may be limiting your progress.</p>' : ''}
      ${reportData.mindsetScore >= 6 ? '<p style="color: #22c55e;">✨ <strong>Exceptional mindset:</strong> Your positive outlook is a powerful asset for financial growth.</p>' : ''}
      ${reportData.healthScore >= 70 ? '<p style="color: #22c55e;">💪 <strong>Strong foundation:</strong> You have a solid financial base to build upon.</p>' : ''}
    </div>

    <div class="section">
      <h3>📚 Your Personalized Homework for Tool 2 Preparation</h3>
      
      ${reportData.healthScore < 40 || (reportData.data && reportData.data.totalDebt === 'over_100k') ? `
      <div style="background: rgba(239, 68, 68, 0.1); border-left: 4px solid #ef4444; padding: 15px; margin-bottom: 15px; border-radius: 5px;">
        <h4 style="color: #ef4444; margin-top: 0;">🔴 Priority 1: Debt & Cash Flow Review (Critical)</h4>
        <ul style="color: #e2e8f0; list-style-type: none; padding-left: 0;">
          <li style="padding: 5px 0;">☐ List all debts with balances, interest rates, and minimum payments</li>
          <li style="padding: 5px 0;">☐ Calculate total monthly debt payments</li>
          <li style="padding: 5px 0;">☐ Identify highest interest rate debts</li>
          <li style="padding: 5px 0;">☐ Review last 3 months of bank statements</li>
        </ul>
      </div>
      ` : ''}
      
      ${reportData.healthScore < 60 || (reportData.data && reportData.data.emergencyFund === 'none') ? `
      <div style="background: rgba(245, 158, 11, 0.1); border-left: 4px solid #f59e0b; padding: 15px; margin-bottom: 15px; border-radius: 5px;">
        <h4 style="color: #f59e0b; margin-top: 0;">🟡 Priority 2: Expense Tracking</h4>
        <ul style="color: #e2e8f0; list-style-type: none; padding-left: 0;">
          <li style="padding: 5px 0;">☐ Track all expenses for next 7 days</li>
          <li style="padding: 5px 0;">☐ Identify top 3 spending categories</li>
          <li style="padding: 5px 0;">☐ Find 3 expenses you could reduce</li>
          <li style="padding: 5px 0;">☐ Calculate true monthly living costs</li>
        </ul>
      </div>
      ` : ''}
      
      <div style="background: rgba(34, 197, 94, 0.1); border-left: 4px solid #22c55e; padding: 15px; margin-bottom: 15px; border-radius: 5px;">
        <h4 style="color: #22c55e; margin-top: 0;">🟢 Priority 3: Income & Assets Review</h4>
        <ul style="color: #e2e8f0; list-style-type: none; padding-left: 0;">
          <li style="padding: 5px 0;">☐ Gather last 2 pay stubs</li>
          <li style="padding: 5px 0;">☐ List all income sources</li>
          <li style="padding: 5px 0;">☐ Check all account balances</li>
          <li style="padding: 5px 0;">☐ Review any investment accounts</li>
        </ul>
      </div>
    </div>

    <div class="section">
      <h3>🎯 Next Steps</h3>
      <ol style="color: #e2e8f0;">
        <li style="padding: 5px 0;">Complete your personalized homework tasks above</li>
        <li style="padding: 5px 0;">Take Tool 2: Financial Clarity Assessment (Week 2)</li>
        ${reportData.mindsetScore < 0 ? '<li style="padding: 5px 0;">Prepare for Tool 3: Control Fear Grounding (Week 3)</li>' : ''}
        <li style="padding: 5px 0;">Track your progress weekly</li>
        <li style="padding: 5px 0;">Celebrate small wins along your journey</li>
      </ol>
    </div>
    
    <div class="section" style="text-align: center; background: linear-gradient(135deg, rgba(173, 145, 104, 0.2) 0%, rgba(30, 25, 43, 0.4) 100%);">
      <p style="font-size: 18px; color: #AD9168; margin: 0;">Remember: Every financial journey starts with a single step.</p>
      <p style="color: #94a3b8; margin-top: 10px;">You've taken that step today. Keep moving forward!</p>
    </div>
  </div>
</body>
</html>
        `;
        
        // Create a Blob and download
        const blob = new Blob([htmlContent], { type: 'text/html' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `FinancialTruPath_Report_${new Date().toISOString().split('T')[0]}.html`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        console.log('Report downloaded successfully');
      }
      
      // Show insights panel
      window.showInsights = function(insights) {
        const panel = document.getElementById('insights-panel');
        const content = document.getElementById('insights-content');
        
        let html = '<ul class="space-y-2">';
        insights.forEach(insight => {
          const priorityColor = insight.priority === 'high' ? 'text-red-600' : 
                               insight.priority === 'critical' ? 'text-red-800' : 
                               'text-blue-600';
          html += `
            <li class="border-l-4 border-blue-400 pl-4">
              <p class="font-medium ${priorityColor}">${insight.message}</p>
              <p class="text-sm text-gray-600 mt-1">${insight.recommendation}</p>
            </li>
          `;
        });
        html += '</ul>';
        
        content.innerHTML = html;
        panel.style.display = 'block';
      }
      
      // Load Financial Clarity Tool (Tool 2)
      window.loadFinancialClarityTool = function() {
        const html = `
          <h2>💰 Tool 2: Financial Clarity Assessment</h2>
          <div class="hr"></div>
          <p class="muted" style="margin-bottom: 20px;">
            This tool helps you gain clarity on your complete financial picture.
          </p>
          
          <div style="background: rgba(173, 145, 104, 0.2); border-radius: 15px; padding: 30px; text-align: center;">
            <p style="color: var(--gold); font-size: 18px; margin-bottom: 15px;">
              🚧 Coming in Week 2
            </p>
            <p class="muted">
              This comprehensive financial assessment will help you understand:<br><br>
              • Your income and expense patterns<br>
              • Debt situation and management strategies<br>
              • Savings and investment readiness<br>
              • Areas needing immediate attention
            </p>
          </div>
        `;
        
        document.getElementById('tool-container').innerHTML = html;
      }
      
      // Auto-save functionality
      let autoSaveTimer;
      window.enableAutoSave = function() {
        document.addEventListener('input', function() {
          clearTimeout(autoSaveTimer);
          autoSaveTimer = setTimeout(function() {
            console.log('Auto-saving...');
            // Implement auto-save logic here
          }, 30000); // 30 seconds
        });
      }
      
      // Initialize
      enableAutoSave();
    </script>
  </body>
</html>
