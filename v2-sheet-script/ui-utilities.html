<script>
/**
 * UI Utilities for TruPath Financial Platform V2.0
 * Extracted from index.html for performance optimization
 * Version: V11.40+ (Performance Optimized)
 */

// Display the full insights report in a modal (like when first generated)
function displayInsightsReportInModal(report, originalSubmission) {
  console.log('Displaying insights report in modal:', report);
  
  // Create modal for viewing full insights report
  const modal = document.createElement('div');
  modal.id = 'insights-report-modal';
  modal.className = 'tool-modal show';
  
  const submissionDate = originalSubmission.timestamp ? 
    new Date(originalSubmission.timestamp).toLocaleDateString() : 'Unknown date';
  
  // Create backdrop
  const backdrop = document.createElement('div');
  backdrop.className = 'modal-backdrop';
  backdrop.onclick = closeInsightsReportModal;
  
  // Create modal content
  const modalContent = document.createElement('div');
  modalContent.className = 'modal-content';
  modalContent.style.maxWidth = '900px';
  modalContent.style.maxHeight = '90vh';
  modalContent.style.overflow = 'auto';
  
  // Create header
  const header = document.createElement('div');
  header.className = 'modal-header';
  
  const title = document.createElement('h2');
  title.textContent = 'üìä Your Personalized Insights Report';
  
  const closeBtn = document.createElement('button');
  closeBtn.className = 'close-btn';
  closeBtn.textContent = '√ó';
  closeBtn.onclick = closeInsightsReportModal;
  
  header.appendChild(title);
  header.appendChild(closeBtn);
  
  // Create body with the actual insights report content
  const body = document.createElement('div');
  body.className = 'modal-body';
  body.style.padding = '20px';
  
  // Add submission date info at the top
  const dateInfo = document.createElement('div');
  dateInfo.style.textAlign = 'center';
  dateInfo.style.marginBottom = '20px';
  dateInfo.style.color = 'var(--muted)';
  dateInfo.innerHTML = `<p>Report generated on ${submissionDate}</p>`;
  body.appendChild(dateInfo);
  
  // Add the full insights report content (same as displayInsightsReport but in modal)
  const reportContent = document.createElement('div');
  reportContent.innerHTML = `
    <div style="animation: fadeIn 0.5s;">
      <!-- Profile Type Card -->
      <div class="card" style="text-align: center; background: linear-gradient(135deg, rgba(173, 145, 104, 0.2) 0%, rgba(30, 25, 43, 0.4) 100%);">
        <div style="font-size: 60px; margin-bottom: 20px;">${report.profile.emoji}</div>
        <h3 style="font-size: 28px; margin-bottom: 10px; color: var(--gold);">
          ${report.profile.type}
        </h3>
        <p style="font-size: 16px; margin-bottom: 15px;">${report.profile.message}</p>
        <p class="muted">${report.profile.focus}</p>
      </div>
      
      <!-- Scores Grid -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
        <div class="card" style="text-align: center;">
          <h4 style="color: var(--gold); margin-bottom: 10px;">Financial Health Score</h4>
          <div style="font-size: 48px; font-weight: bold; color: ${report.healthScore >= 70 ? 'var(--ok)' : report.healthScore >= 40 ? 'var(--gold)' : 'var(--bad)'};">
            ${report.healthScore}
          </div>
          <p class="muted">out of 100</p>
        </div>
        
        <div class="card" style="text-align: center;">
          <h4 style="color: var(--gold); margin-bottom: 10px;">Mindset Score</h4>
          <div style="font-size: 48px; font-weight: bold; color: ${report.mindsetScore >= 3 ? 'var(--ok)' : report.mindsetScore >= 0 ? 'var(--gold)' : 'var(--bad)'};">
            ${report.mindsetScore > 0 ? '+' : ''}${report.mindsetScore}
          </div>
          <p class="muted">range: -9 to +9</p>
        </div>
      </div>
      
      <!-- Key Insights -->
      <div class="card" style="margin-top: 20px;">
        <h4 style="color: var(--gold); margin-bottom: 15px;">üîç Key Insights for You</h4>
        <ul style="list-style: none; padding: 0;">
          ${report.healthScore < 40 ? '<li style="margin-bottom: 10px;">‚ö†Ô∏è <strong>Immediate attention needed:</strong> Focus on emergency savings and debt reduction</li>' : ''}
          ${report.data.totalDebt > 50000 ? '<li style="margin-bottom: 10px;">üí∞ <strong>High debt burden:</strong> Prioritize debt elimination strategies</li>' : ''}
          ${report.data.emergencyFund == 0 ? '<li style="margin-bottom: 10px;">üö® <strong>No emergency fund:</strong> Start with $1,000 emergency fund immediately</li>' : ''}
          ${report.mindsetScore < 0 ? '<li style="margin-bottom: 10px;">üß† <strong>Mindset barriers detected:</strong> Your beliefs about money need attention</li>' : ''}
          ${report.mindsetScore >= 6 ? '<li style="margin-bottom: 10px;">‚ú® <strong>Exceptional mindset:</strong> Your positive outlook is a major advantage</li>' : ''}
          <li style="margin-bottom: 10px;">üìà <strong>Next focus:</strong> ${report.data.primaryGoal === 'retirement' ? 'Retirement planning tools will be crucial' : report.data.primaryGoal === 'debt' ? 'Debt elimination should be your priority' : 'Building financial foundations'}</li>
        </ul>
      </div>
      
      <!-- Action Plan -->
      <div class="card" style="margin-top: 20px;">
        <h4 style="color: var(--gold); margin-bottom: 15px;">üìã Your Personalized Action Plan</h4>
        <ol style="padding-left: 20px; line-height: 1.8;">
          <li>Complete Tool 2: Financial Clarity (Week 2) for detailed assessment</li>
          ${report.mindsetScore < 0 ? '<li>Focus on Tool 3: Control Fear Grounding (Week 3) for mindset work</li>' : ''}
          ${report.data.primaryGoal === 'retirement' ? '<li>Prioritize Tools 6 & 8 for retirement planning</li>' : ''}
          ${report.data.emergencyFund == 0 ? '<li>Start building $1,000 emergency fund this month</li>' : ''}
          <li>Review this report weekly and track progress</li>
        </ol>
      </div>
      
      <!-- Financial Clarity Prep Work -->
      <div class="card" style="margin-top: 20px; background: linear-gradient(135deg, rgba(24, 139, 246, 0.1) 0%, rgba(173, 145, 104, 0.1) 100%);">
        <h4 style="color: var(--gold); margin-bottom: 15px;">üìù Your Homework: Prepare for Tool 2 - Financial Clarity</h4>
        <p class="muted" style="margin-bottom: 15px;">Tool 2 will deep-dive into your finances. Based on your profile, prioritize gathering this information:</p>
        
        ${report.healthScore < 40 || report.data.totalDebt > 25000 ? `
          <div style="margin-bottom: 20px;">
            <h5 style="color: var(--bad); margin-bottom: 10px;">üî¥ Priority 1: Debt Documentation (Critical for You)</h5>
            <ul style="list-style: none; padding-left: 0;">
              <li>‚òê List ALL debts: credit cards, loans, medical, personal</li>
              <li>‚òê For each debt, write down: Balance, Interest Rate, Minimum Payment</li>
              <li>‚òê Calculate total minimum monthly debt payments</li>
              <li>‚òê Identify highest interest rate debt</li>
            </ul>
          </div>
        ` : ''}
        
        ${report.data.emergencyFund <= 1 || report.healthScore < 50 ? `
          <div style="margin-bottom: 20px;">
            <h5 style="color: var(--warn); margin-bottom: 10px;">üü° Priority ${report.data.totalDebt > 25000 ? '2' : '1'}: Expense Tracking (Important for You)</h5>
            <ul style="list-style: none; padding-left: 0;">
              <li>‚òê List all monthly fixed expenses (rent, insurance, subscriptions)</li>
              <li>‚òê Track this week's variable spending (food, gas, entertainment)</li>
              <li>‚òê Identify your 3 biggest expense categories</li>
              <li>‚òê Find 3 expenses you could reduce or eliminate</li>
            </ul>
          </div>
        ` : ''}
        
        ${report.data.annualIncome && parseInt(report.data.annualIncome) > 0 ? `
          <div style="margin-bottom: 20px;">
            <h5 style="color: var(--ok); margin-bottom: 10px;">üü¢ Priority ${report.healthScore < 40 ? '3' : '2'}: Income & Assets Review</h5>
            <ul style="list-style: none; padding-left: 0;">
              <li>‚òê Gather last 2 pay stubs</li>
              <li>‚òê List all income sources and amounts</li>
              <li>‚òê Check all account balances (checking, savings, retirement)</li>
              <li>‚òê Note any expected income changes in next 6 months</li>
            </ul>
          </div>
        ` : ''}
        
        ${report.data.primaryGoal === 'retirement' || report.data.retirementAccess !== 'none' ? `
          <div style="margin-bottom: 20px;">
            <h5 style="color: var(--gold); margin-bottom: 10px;">‚ú® Bonus: Retirement Account Review</h5>
            <ul style="list-style: none; padding-left: 0;">
              <li>‚òê Find your 401k/IRA balance and contribution rate</li>
              <li>‚òê Check if you're getting full employer match</li>
              <li>‚òê Calculate years until retirement goal</li>
            </ul>
          </div>
        ` : ''}
        
        <div style="background: rgba(173, 145, 104, 0.1); border-radius: 10px; padding: 15px; margin-top: 15px;">
          <p style="margin: 0; font-size: 14px;">
            <strong>üí° Pro Tip:</strong> ${
              report.healthScore < 40 ? 
              'Focus on the debt documentation first - this will be crucial for creating your debt elimination strategy.' :
              report.data.emergencyFund == 0 ?
              'Tracking expenses this week will reveal where your emergency fund money can come from.' :
              'Having these numbers ready will make Tool 2 much more powerful and actionable for you.'
            }
          </p>
        </div>
      </div>
    </div>
  `;
  body.appendChild(reportContent);
  
  // Enhanced buttons section
  const buttonsSection = document.createElement('div');
  buttonsSection.style.textAlign = 'center';
  buttonsSection.style.marginTop = '30px';
  buttonsSection.style.padding = '20px';
  buttonsSection.style.borderTop = '1px solid var(--border)';
  
  const closeButton = document.createElement('button');
  closeButton.className = 'btn btn-secondary';
  closeButton.style.marginRight = '10px';
  closeButton.textContent = '‚úï Close';
  closeButton.onclick = closeInsightsReportModal;
  
  const editButton = document.createElement('button');
  editButton.className = 'btn btn-primary';
  editButton.style.marginRight = '10px';
  editButton.textContent = '‚úèÔ∏è Edit Answers & Generate New Report';
  editButton.onclick = function() {
    editAndGenerateNewReport(originalSubmission.data);
  };
  
  const downloadButton = document.createElement('button');
  downloadButton.className = 'btn btn-secondary';
  downloadButton.textContent = 'üìÑ Download Report';
  downloadButton.onclick = function(event) {
    // Store report for download
    window.lastGeneratedReport = report;
    downloadReport(event);
  };
  
  const helpButton = document.createElement('button');
  helpButton.className = 'btn btn-secondary';
  helpButton.style.marginLeft = '10px';
  helpButton.style.background = 'rgba(173, 145, 104, 0.2)';
  helpButton.style.borderColor = 'var(--gold)';
  helpButton.textContent = '‚ùì Help';
  helpButton.onclick = function() {
    showHelpModal('modal');
  };
  
  buttonsSection.appendChild(closeButton);
  buttonsSection.appendChild(editButton);
  buttonsSection.appendChild(downloadButton);
  buttonsSection.appendChild(helpButton);
  
  // Assemble modal
  body.appendChild(buttonsSection);
  modalContent.appendChild(header);
  modalContent.appendChild(body);
  modal.appendChild(backdrop);
  modal.appendChild(modalContent);
  
  document.body.appendChild(modal);
}

// Close insights report modal
function closeInsightsReportModal() {
  const modal = document.getElementById('insights-report-modal');
  if (modal) {
    modal.remove();
  }
}

// Edit answers and generate new report from insights view
function editAndGenerateNewReport(originalData) {
  closeInsightsReportModal();
  
  // First, navigate to the form page
  startTool1Form();
  
  // Wait a moment for the form to load, then populate with data
  setTimeout(function() {
    if (typeof populateFormWithData === 'function') {
      populateFormWithData(originalData);
    } else {
      console.warn('populateFormWithData function not available');
    }
  }, 1000);
}

// Helper function to load data into form (reuse existing logic)
function populateFormWithData(data) {
  console.log('Populating form with data:', data);
  
  if (!data) {
    console.warn('No data provided to populate form');
    return;
  }
  
  // Iterate through the data and populate form fields
  Object.keys(data).forEach(function(fieldName) {
    const field = document.getElementById(fieldName) || document.querySelector(`[name="${fieldName}"]`);
    if (field) {
      if (field.type === 'radio') {
        const radioButton = document.querySelector(`input[name="${fieldName}"][value="${data[fieldName]}"]`);
        if (radioButton) {
          radioButton.checked = true;
        }
      } else if (field.type === 'checkbox') {
        field.checked = data[fieldName];
      } else if (field.tagName === 'SELECT') {
        field.value = data[fieldName];
      } else {
        field.value = data[fieldName];
      }
    }
  });
  
  console.log('Form populated with existing data');
}

// Display version selector for drafts and submissions
function displayVersionSelector(versions) {
  console.log('Displaying version selector with versions:', versions);
  
  if (!versions || versions.length === 0) {
    alert('No saved versions found.');
    return;
  }
  
  // Create modal for version selection
  const modal = document.createElement('div');
  modal.id = 'version-selector-modal';
  modal.className = 'tool-modal show';
  
  // Create backdrop
  const backdrop = document.createElement('div');
  backdrop.className = 'modal-backdrop';
  backdrop.onclick = function() {
    modal.remove();
  };
  
  // Create modal content
  const modalContent = document.createElement('div');
  modalContent.className = 'modal-content';
  modalContent.style.maxWidth = '600px';
  
  // Create header
  const header = document.createElement('div');
  header.className = 'modal-header';
  
  const title = document.createElement('h2');
  title.textContent = 'üìÇ Load Saved Version';
  
  const closeBtn = document.createElement('button');
  closeBtn.className = 'close-btn';
  closeBtn.textContent = '√ó';
  closeBtn.onclick = function() {
    modal.remove();
  };
  
  header.appendChild(title);
  header.appendChild(closeBtn);
  
  // Create body
  const body = document.createElement('div');
  body.className = 'modal-body';
  
  // Add instructions
  const instructions = document.createElement('p');
  instructions.textContent = 'Choose a version to load:';
  instructions.className = 'muted';
  body.appendChild(instructions);
  
  // Create version list
  const versionList = document.createElement('div');
  versionList.className = 'load-options';
  
  versions.forEach(function(version, index) {
    const versionItem = document.createElement('div');
    versionItem.className = 'load-option';
    
    const date = new Date(version.timestamp).toLocaleString();
    const status = version.isSubmitted ? 'Completed' : 'Draft';
    const statusColor = version.isSubmitted ? 'var(--ok)' : 'var(--gold)';
    
    versionItem.innerHTML = `
      <h3>${version.label || status} - ${date}</h3>
      <p style="color: ${statusColor};">Status: ${status}</p>
      <p class="muted">Data available: ${Object.keys(version.data || {}).length} fields</p>
    `;
    
    const loadButton = document.createElement('button');
    loadButton.className = 'btn-primary';
    loadButton.textContent = `Load ${status}`;
    loadButton.onclick = function() {
      loadSpecificDraft(version);
      modal.remove();
    };
    
    versionItem.appendChild(loadButton);
    versionList.appendChild(versionItem);
  });
  
  body.appendChild(versionList);
  
  // Assemble modal
  modalContent.appendChild(header);
  modalContent.appendChild(body);
  modal.appendChild(backdrop);
  modal.appendChild(modalContent);
  
  document.body.appendChild(modal);
}

// Load specific draft or submission
function loadSpecificDraft(draft) {
  console.log('Loading specific draft:', draft);
  
  if (!draft || !draft.data) {
    alert('Invalid draft data');
    return;
  }
  
  // Navigate to form if not already there
  if (!document.getElementById('orientationForm')) {
    startTool1Form();
    setTimeout(function() {
      populateFormWithData(draft.data);
    }, 1000);
  } else {
    populateFormWithData(draft.data);
  }
  
  // Show notification
  if (typeof showNotification === 'function') {
    showNotification(`${draft.isSubmitted ? 'Submission' : 'Draft'} loaded successfully`, 'success');
  }
}

// Update landing page buttons based on available data
function updateLandingPageButtons(status, data) {
  console.log('Updating landing page buttons:', status, data);
  
  // Update button states based on what's available
  const startBtn = document.getElementById('start-tool1-btn');
  const loadBtn = document.getElementById('load-draft-btn');
  const viewBtn = document.getElementById('view-report-btn');
  
  if (startBtn) {
    startBtn.textContent = data && Object.keys(data).length > 0 ? '‚úèÔ∏è Continue Assessment' : 'üöÄ Start Assessment';
  }
  
  if (loadBtn) {
    loadBtn.style.display = status.hasDrafts ? 'inline-block' : 'none';
  }
  
  if (viewBtn) {
    viewBtn.style.display = status.hasCompletedSubmission ? 'inline-block' : 'none';
  }
  
  // Update progress information if available
  const progressInfo = document.getElementById('progress-info');
  if (progressInfo && data) {
    const completedFields = Object.keys(data).length;
    const totalFields = 25; // Tool1 has 25 fields
    const percentage = Math.round((completedFields / totalFields) * 100);
    
    progressInfo.innerHTML = `
      <div class="progress-container">
        <div class="progress-bar">
          <div class="progress-fill" style="width: ${percentage}%"></div>
        </div>
        <div class="progress-text">
          <span>${completedFields} of ${totalFields} fields completed</span>
          <span class="progress-separator">‚Ä¢</span>
          <span>${percentage}% complete</span>
        </div>
      </div>
    `;
  }
}
</script>